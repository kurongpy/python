> 什么是并发？

在[操作系统](https://baike.baidu.com/item/操作系统)中，并发是指一个时间段中有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在同一个[处理机](https://baike.baidu.com/item/处理机)上运行，但任一个时刻点上只有一个程序在处理机上运行。

在关系数据库中，允许多个用户同时访问和更改共享数据的进程。SQL Server 使用锁定以允许多个用户同时访问和更改共享数据而彼此之间不发生冲突。



> 并发的特点

并发环境下，由于程序的封闭性被打破，出现了新的特点：

1. 程序与计算不再一一对应，一个程序副本可以有多个计算
2. [并发程序](https://baike.baidu.com/item/并发程序)之间有相互制约关系，直接制约体现为一个程序需要另一个程序的计算结果，间接制约体现为多个程序竞争某一资源，如处理机、[缓冲区](https://baike.baidu.com/item/缓冲区)等。
3. [并发程序](https://baike.baidu.com/item/并发程序)在执行中是走走停停，断续推进的。

> 并发与并行

**并发：**当有多个线程在操作时,如果系统只有一个CPU,则它根本不可能真正同时进行一个以上的线程，它只能把CPU运行时间划分成若干个时间段,再将时间 段分配给各个线程执行，在一个时间段的线程代码运行时，其它线程处于挂起状。.这种方式我们称之为并发(Concurrent)。

**并行：**当系统有一个以上CPU时,则线程的操作有可能非并发。当一个CPU执行一个线程时，另一个CPU可以执行另一个线程，两个线程互不抢占CPU资源，可以同时进行，这种方式我们称之为并行(Parallel)。

**区别：**并发和并行是即相似又有区别的两个概念，并行是指两个或者多个事件在同一时刻发生；而并发是指两个或多个事件在同一时间间隔内发生。在[多道程序](https://baike.baidu.com/item/多道程序)环境下，[并发性](https://baike.baidu.com/item/并发性)是指在一段时间内宏观上有多个程序在同时运行，但在[单处理机系统](https://baike.baidu.com/item/单处理机系统)中，每一时刻却仅能有一道程序执行，故微观上这些程序只能是分时地交替执行。倘若在[计算机系统](https://baike.baidu.com/item/计算机系统)中有多个[处理机](https://baike.baidu.com/item/处理机)，则这些可以并发执行的程序便可被分配到多个处理机上，实现[并行执行](https://baike.baidu.com/item/并行执行)，即利用每个处理机来处理一个可并发执行的程序，这样，多个程序便可以同时执行。 [2]

> 什么是多任务

多任务处理是指用户可以在同一时间内运行多个应用程序。

当多任务操作系统使用某种任务调度策略允许两个或更多进程并发共享一个处理器时，事实上处理器在某一时刻只会给一件任务提供服务。因为任务调度机制保证不同任务之间的切换速度十分迅速，因此给人多个任务同时运行的错觉。多任务系统中有3个功能单位：任务、进程和线程。

操作系统轮流让各个任务交替进行，任务1执行0.01秒，切换到任务2执行0.01秒，再切换到任务3执行0.01秒，之后切换回任务1，这样反复执行下去，表面上任务是交替之行的，由于处理器执行速度太快，我们感觉所有任务在同时运行。

> 进程实现多任务：什么是进程？

进程的概念主要有两点：第一，进程是一个实体。每一个进程都有它自己的地址空间，一般情况下，包括[文本](https://baike.baidu.com/item/文本)区域（text region）、数据区域（data region）和[堆栈](https://baike.baidu.com/item/堆栈)（stack region）。文本区域存储处理器执行的代码；数据区域存储变量和进程执行期间使用的动态分配的内存；堆栈区域存储着活动过程调用的指令和本地变量。第二，进程是一个“执行中的程序”。程序是一个没有生命的实体，只有[处理](https://baike.baidu.com/item/处理)器赋予程序生命时（操作系统执行之），它才能成为一个活动的实体，我们称其为[进程](https://baike.baidu.com/item/进程)。

在python3中对多进程支持的是multiprocessing模块，它有一个process类能够创建子进程。

> 什么是CPU密集型计算和I/O密集型计算？

CPU密集型（CPU bound：任务的运行受cpu的限制）：也叫计算密集型，I/O在很短的时间就可已完成，CPU需要大量的计算和处理，特点是CPU占用率相当高。比如：压缩解压缩，加密解密，正则表达式搜索



I/O密集型（I/O bound：任务的运行受io的限制）：指系统运作的大部分状况是

CPU在等待I/O（硬盘/内存）的读写操作，CPU占用率任然较低。比如：文件处理程序、网络爬虫程序、读写数据库程序。



简而言之，如果程序依赖大量外部数据源，比如内存磁盘和网络，那么它就是I/O密集型，否则若只在CPU中进行计算，那就是CPU密集型。



> 多线程、多进程、多协程的对比

多进程Process（multiprocessing）：

​	优点：可以使用多核CPU进行并行计算

​	缺点：占用资源比线程更多，可启动数目比线程小

​	受CPU数量的限制，因此它使用于CPU密集型计算



多线程Thread（threading）：

​	优点：相比进程，更轻量级，占用资源少。

​	缺点：相比进程，在python中多线程只能并发执行，不能利用多cpu（GIL：全局解释器锁）；相比协程，启动数目有限制，占用内存资源，有线程切换开销。

​	因此多线程适用于I/O密集型计算，同时运行的任务数目要求不多。



多协程Coroutine（asyncio）：

​	优点：内存开销最小，可启动的数量非常多

​	缺点：当前python的支持库有限制（aiohttp vs requests），不支持协程，代码实现复杂。如果是爬虫要用协程处理，只能用aiohttp这个库，不能用requests。

​	因此，它适用于I/O密集型计算，需要超多任务进行，但有现成库支持的场景。

一个进程中可以保函和启动多个线程，一个线程中可以启动很多个协程。

> 该怎么根据任务选择对应的技术

如果是CPU密集型，直接选择多进程multiprocessing。

如果是I/O密集型，看任务量是否超多、是否有现成协程库支持、协程实现复杂度是否可接收，权衡这三点，决定使用协程还是使用多线程。



>  重要知识点 - 什么是进程(process)和线程(thread)

 

进程是操作系统分配资源的最小单元, 线程是操作系统调度的最小单元。

一个应用程序至少包括1个进程，而1个进程包括1个或多个线程，线程的尺度更小。

每个进程在执行过程中拥有独立的内存单元，而一个线程的多个线程在执行过程中共享内存。

 

网上有篇阮一峰的博客曾对进程和线程做出了一个非常浅显的解释，我在这里贴出来方便大家理解。

 计算机的核心是CPU，它承担了所有的计算任务。它就像一座工厂，时刻在运行。

假定工厂的电力有限，一次只能供给一个车间使用。也就是说，一个车间开工的时候，其他车间都必须停工。背后的含义就是，单个CPU一次只能运行一个任务。编者注: 多核的CPU就像有了多个发电厂，使多工厂(多进程)实现可能。

进程就好比工厂的车间，它代表CPU所能处理的单个任务。任一时刻，CPU总是运行一个进程，其他进程处于非运行状态。

一个车间里，可以有很多工人。他们协同完成一个任务。

线程就好比车间里的工人。一个进程可以包括多个线程。

车间的空间是工人们共享的，比如许多房间是每个工人都可以进出的。这象征一个进程的内存空间是共享的，每个线程都可以使用这些共享内存。

可是，每间房间的大小不同，有些房间最多只能容纳一个人，比如厕所。里面有人的时候，其他人就不能进去了。这代表一个线程使用某些共享内存时，其他线程必须等它结束，才能使用这一块内存。

一个防止他人进入的简单方法，就是门口加一把锁。先到的人锁上门，后到的人看到上锁，就在门口排队，等锁打开再进去。这就叫"互斥锁"（Mutual exclusion，缩写 Mutex），防止多个线程同时读写某一块内存区域。

还有些房间，可以同时容纳n个人，比如厨房。也就是说，如果人数大于n，多出来的人只能在外面等着。这好比某些内存区域，只能供给固定数目的线程使用。

这时的解决方法，就是在门口挂n把钥匙。进去的人就取一把钥匙，出来时再把钥匙挂回原处。后到的人发现钥匙架空了，就知道必须在门口排队等着了。这种做法叫做"信号量"（Semaphore），用来保证多个线程不会互相冲突。

不难看出，mutex是semaphore的一种特殊情况（n=1时）。也就是说，完全可以用后者替代前者。但是，因为mutex较为简单，且效率高，所以在必须保证资源独占的情况下，还是采用这种设计。